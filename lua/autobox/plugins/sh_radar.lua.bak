-----
--draws a radar minimap
-----
local PLUGIN = {}
PLUGIN.title = "radar"
PLUGIN.author = "Trist"
PLUGIN.description = "draws a radar minimap"
PLUGIN.Processed = false

function PLUGIN:ProcessMap()

    local customRT = GetRenderTarget("AAT_RT",1024,1024,true)
    local oldRT = render.GetRenderTarget()
    local w, h = ScrW(),ScrH()

    render.SetViewPort(0, 0, 1024, 1024)
    render.SetRenderTarget(customRT)


    render.Clear(0,0,0,255)

    cam.Start2D()
    local q = 26
    local size = 512
    for i = -size, size do
        for j = -size, size do
            local tr = util.TraceLine({
                start = Vector(i * q , j * q , 3000),
                endpos = Vector(i * q , j * q , -12000),
                collisiongroup = 20
            })
            local s = 8
            local d =  (tr.StartPos:Distance(tr.HitPos) / (15000 / s)) * 255 - (225 * s)
            if (d < 0) then d = 0 end
            if (tr.HitWorld) then surface.SetDrawColor(Color(d,d,d)) else surface.SetDrawColor(color_black) end
            surface.DrawRect( size-i, j + size , 1 , 1)
        end
    end
    cam.End2D()

    local data = render.Capture( {
    format = "jpeg",
        quality = 100,
        h = ScrH(),
        w = ScrW(),
        x = 0,
        y = 0,
    } )
    local f = file.Open( "MapData.jpg", "wb", "DATA" )
    f:Write( data )
    f:Close()

    render.SetViewPort( 0, 0, w, h )
    render.SetRenderTarget( oldRT )
    data = render.Capture( {
        format = "jpeg",
            quality = 100,
            h = ScrH(),
            w = ScrW(),
            x = 0,
            y = 0,
        } )
        f = file.Open( "ScreenData.jpg", "wb", "DATA" )
        f:Write( data )
        f:Close()

    local  MyIMaterial = CreateMaterial("AAT_RT","UnlitGeneric",{
        ["$basetexture"] = "models/shadertest/shader5", --placeholder to be changed on demand
        ["$vertexcolor"] = 1, --allows custom coloring
        ["$vertexalpha"] = 1, --allows custom coloring
        ["$model"] = 1, --???; i see other code using it so i always do whatever
    })
    --now whenever you want to set a new RT to render from, you change it on this material with:
    MyIMaterial:SetTexture("$basetexture",customRT)
    self.Material = Material("!AAT_RT")





    self.Processed = true
end

function PLUGIN:HUDPaint()

    if (!self.Processed) then self:ProcessMap() end
    surface.SetDrawColor(color_white)
    surface.SetMaterial(self.Material)
    surface.DrawTexturedRect(0,0, 1024, 1024)

end

autobox:RegisterPlugin(PLUGIN)

--bit.band(util.PointContents(),CONTENTS_SOLID) == 1